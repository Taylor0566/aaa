<template>
  <AdminLayout current-path="content" page-title="å†…å®¹ç®¡ç†">
    <view class="content-manage">
      <!-- ç­›é€‰æ  -->
      <view class="filter-card">
        <view class="filter-item search-box">
          <text class="iconfont search-icon">ğŸ”</text>
          <input 
            v-model="filter.keyword" 
            placeholder="è¯·è¾“å…¥å†…å®¹æ ‡é¢˜æœç´¢" 
            class="search-input"
          />
        </view>
        
        <view class="filter-item">
          <picker v-model="filter.contentType" :range="contentTypeOptions" range-key="label">
            <view class="select-box">
              {{ contentTypeOptions.find(item => item.value === filter.contentType).label }}
              <text class="arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <view class="filter-item">
          <picker v-model="filter.status" :range="statusOptions" range-key="label">
            <view class="select-box">
              {{ statusOptions.find(item => item.value === filter.status).label }}
              <text class="arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <view class="filter-item date-range">
          <picker mode="date" v-model="filter.startDate">
            <view class="date-picker">{{ filter.startDate || 'å¼€å§‹æ—¥æœŸ' }}</view>
          </picker>
          <text class="date-separator">-</text>
          <picker mode="date" v-model="filter.endDate">
            <view class="date-picker">{{ filter.endDate || 'ç»“æŸæ—¥æœŸ' }}</view>
          </picker>
        </view>
        
        <button @click="getContentList" class="btn btn-primary">æŸ¥è¯¢</button>
      </view>
      
      <!-- å†…å®¹åˆ—è¡¨ -->
      <view class="table-card">
        <view class="table-header">
          <view class="col col-title">æ ‡é¢˜</view>
          <view class="col col-type">ç±»å‹</view>
          <view class="col col-user">å‘å¸ƒäºº</view>
          <view class="col col-date">å‘å¸ƒæ—¶é—´</view>
          <view class="col col-status">çŠ¶æ€</view>
          <view class="col col-action">æ“ä½œ</view>
        </view>
        
        <view class="table-body">
          <view class="table-row" v-for="content in contentList" :key="content._id">
            <view class="col col-title">
              <text class="title-text">{{ content.title || 'æ— æ ‡é¢˜' }}</text>
            </view>
            <view class="col col-type">
              <text class="type-tag">{{ contentTypeOptions.find(item => item.value === content.content_type)?.label || 'æœªçŸ¥' }}</text>
            </view>
            <view class="col col-user">{{ content.username || 'åŒ¿åç”¨æˆ·' }}</view>
            <view class="col col-date">{{ formatDate(content.created_at) }}</view>
            <view class="col col-status">
              <text class="status-badge" :class="getContentStatusClass(content.status)">
                {{ statusOptions.find(item => item.value === content.status)?.label || 'æœªçŸ¥' }}
              </text>
            </view>
            <view class="col col-action">
              <text class="link-btn primary" @click="viewContentDetail(content._id)">è¯¦æƒ…</text>
              <text class="link-btn warning" @click="showAuditPopup(content._id, content.status)">å®¡æ ¸</text>
              <text class="link-btn danger" @click="showDeleteConfirm(content._id)">åˆ é™¤</text>
            </view>
          </view>
        </view>
        
        <!-- åˆ†é¡µæ§ä»¶ -->
        <view class="pagination-container" v-if="total > 0">
          <text class="total-text">å…± {{ total }} æ¡æ•°æ®</text>
          <view class="page-ctrl">
            <button class="page-btn" @click="changePage(page - 1)" :disabled="page <= 1">ä¸Šä¸€é¡µ</button>
            <text class="page-num">{{ page }} / {{ totalPages }}</text>
            <button class="page-btn" @click="changePage(page + 1)" :disabled="page >= totalPages">ä¸‹ä¸€é¡µ</button>
          </view>
        </view>
      </view>
      
      <!-- å®¡æ ¸å¼¹çª— (ä¿æŒåŸæœ‰) -->
      <uni-popup ref="auditPopup" type="dialog">
        <uni-popup-dialog 
          title="å†…å®¹å®¡æ ¸" 
          :content="''"
          @confirm="confirmAudit"
          @cancel="cancelAudit"
        >
          <view class="audit-form">
            <picker v-model="auditForm.status" :range="auditStatusOptions" range-key="label">
              <view class="select-box full-width">
                {{ auditStatusOptions.find(item => item.value === auditForm.status).label }}
                <text class="arrow">â–¼</text>
              </view>
            </picker>
            <textarea 
              v-model="auditForm.reason" 
              placeholder="è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå®¡æ ¸æ‹’ç»æ—¶å¿…å¡«ï¼‰"
              class="reason-input"
              v-if="auditForm.status === 'rejected'"
            ></textarea>
          </view>
        </uni-popup-dialog>
      </uni-popup>
      
      <!-- åˆ é™¤ç¡®è®¤å¼¹çª— (ä¿æŒåŸæœ‰) -->
      <uni-popup ref="deletePopup" type="dialog">
        <uni-popup-dialog 
          title="åˆ é™¤ç¡®è®¤" 
          content="ç¡®å®šè¦åˆ é™¤è¯¥å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åŒæ­¥åˆ é™¤å…³è”è¯„è®ºï¼"
          @confirm="confirmDelete"
          @cancel="cancelDelete"
        ></uni-popup-dialog>
      </uni-popup>
    </view>
  </AdminLayout>
</template>

<script setup>
import { ref, reactive } from 'vue'
import { onLoad, onShow } from '@dcloudio/uni-app'
import AdminLayout from '@/admin/components/AdminLayout.uvue'

// æƒé™æ£€æŸ¥
onShow(() => {
  const token = uni.getStorageSync('adminToken')
  if (!token) {
    uni.reLaunch({ url: '/admin/pages/login/login' })
  }
})

// å†…å®¹ç±»å‹é€‰é¡¹
const contentTypeOptions = ref([
  { value: 'all', label: 'å…¨éƒ¨ç±»å‹' },
  { value: 'article', label: 'æ–‡ç« ' },
  { value: 'image', label: 'å›¾ç‰‡' },
  { value: 'video', label: 'è§†é¢‘' },
  { value: 'audio', label: 'éŸ³é¢‘' }
])

// å†…å®¹çŠ¶æ€é€‰é¡¹
const statusOptions = ref([
  { value: 'all', label: 'å…¨éƒ¨çŠ¶æ€' },
  { value: 'pending', label: 'å¾…å®¡æ ¸' },
  { value: 'approved', label: 'å®¡æ ¸é€šè¿‡' },
  { value: 'rejected', label: 'å®¡æ ¸æ‹’ç»' },
  { value: 'published', label: 'å·²å‘å¸ƒ' }
])

// ç­›é€‰æ¡ä»¶
const filter = reactive({
  keyword: '',
  contentType: 'all',
  status: 'all',
  startDate: '',
  endDate: ''
})

// åˆ—è¡¨æ•°æ®
const contentList = ref([])
const total = ref(0)
const page = ref(1)
const pageSize = ref(10)
const totalPages = ref(0)

// é¡µé¢åŠ è½½è·å–å†…å®¹åˆ—è¡¨
onLoad(() => {
  if (uni.getStorageSync('adminToken')) {
    getContentList()
  }
})

// è·å–å†…å®¹åˆ—è¡¨
const getContentList = async () => {
  try {
    const res = await uniCloud.callFunction({
      name: 'admin-api',
      data: {
        action: 'getContentList',
        keyword: filter.keyword,
        contentType: filter.contentType,
        status: filter.status,
        startDate: filter.startDate,
        endDate: filter.endDate,
        page: page.value,
        pageSize: pageSize.value,
        token: uni.getStorageSync('adminToken')
      }
    })
    if (res.result.code === 200) {
      contentList.value = res.result.data.list
      total.value = res.result.data.total
      totalPages.value = res.result.data.totalPages
    } else {
      uni.showToast({ title: res.result.message, icon: 'none' })
    }
  } catch (e) {
    uni.showToast({ title: 'è·å–å†…å®¹åˆ—è¡¨å¤±è´¥', icon: 'none' })
  }
}

// æŸ¥çœ‹å†…å®¹è¯¦æƒ…
const viewContentDetail = (contentId) => {
  uni.navigateTo({ url: `/admin/pages/content/detail?contentId=${contentId}` })
}

const updateContentStatus = async (contentId, status, reason = '') => {
  try {
    const res = await uniCloud.callFunction({
      name: 'admin-api',
      data: {
        action: 'updateContentStatus',
        content_id: contentId,
        status,
        reason,
        token: uni.getStorageSync('adminToken')
      }
    })
    if (res.result.code === 200) {
      uni.showToast({ title: 'æ“ä½œæˆåŠŸ', icon: 'success' })
      getContentList()
    } else {
      uni.showToast({ title: res.result.message, icon: 'none' })
    }
  } catch (e) {
    uni.showToast({ title: 'æ“ä½œå¤±è´¥', icon: 'none' })
  }
}

const showAuditPopup = (contentId) => {
  uni.showActionSheet({
    itemList: ['é€šè¿‡', 'æ‹’ç»ï¼ˆå»è¯¦æƒ…å¡«å†™åŸå› ï¼‰'],
    success: async ({ tapIndex }) => {
      if (tapIndex === 0) {
        await updateContentStatus(contentId, 'approved', '')
        return
      }
      viewContentDetail(contentId)
    }
  })
}

const showDeleteConfirm = (contentId) => {
  uni.showModal({
    title: 'åˆ é™¤ç¡®è®¤',
    content: 'ç¡®å®šè¦åˆ é™¤è¯¥å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åŒæ­¥åˆ é™¤å…³è”è¯„è®ºï¼',
    confirmText: 'åˆ é™¤',
    confirmColor: '#ff3b30',
    success: async (res) => {
      if (!res.confirm) return
      try {
        const callRes = await uniCloud.callFunction({
          name: 'admin-api',
          data: {
            action: 'deleteContent',
            content_id: contentId,
            token: uni.getStorageSync('adminToken')
          }
        })
        if (callRes.result.code === 200) {
          uni.showToast({ title: 'å†…å®¹åˆ é™¤æˆåŠŸ', icon: 'success' })
          getContentList()
          return
        }
        uni.showToast({ title: callRes.result.message, icon: 'none' })
      } catch (e) {
        uni.showToast({ title: 'åˆ é™¤å†…å®¹å¤±è´¥', icon: 'none' })
      }
    }
  })
}

// åˆ‡æ¢é¡µç 
const changePage = (newPage) => {
  if (newPage < 1 || newPage > totalPages.value) return
  page.value = newPage
  getContentList()
}

// è·å–å†…å®¹çŠ¶æ€æ ·å¼
const getContentStatusClass = (status) => {
  switch (status) {
    case 'pending':
      return 'status-pending'
    case 'approved':
    case 'published':
      return 'status-approved'
    case 'rejected':
      return 'status-rejected'
    default:
      return ''
  }
}

// æ—¥æœŸæ ¼å¼åŒ–
const formatDate = (timestamp) => {
  if (!timestamp) return ''
  const date = new Date(timestamp)
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
}
</script>

<style scoped>
.content-manage {
  padding: 16rpx;
  padding-bottom: 120rpx; /* ç•™å‡ºåº•éƒ¨å¯¼èˆªç©ºé—´ */
  background-color: #f5f5f5;
  min-height: 100vh;
}

.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 16rpx;
  padding: 20rpx;
  background-color: #fff;
  border-radius: 12rpx;
  margin-bottom: 20rpx;
  align-items: center;
}

.search-input {
  flex: 1;
  height: 80rpx;
  padding: 0 20rpx;
  border: 1rpx solid #e5e5e5;
  border-radius: 40rpx;
  font-size: 28rpx;
}

.type-picker, .status-picker {
  font-size: 28rpx;
  color: #666;
  padding: 0 16rpx;
  height: 80rpx;
  border: 1rpx solid #e5e5e5;
  border-radius: 40rpx;
  display: flex;
  align-items: center;
  min-width: 160rpx;
  justify-content: center;
}

.date-filter {
  display: flex;
  gap: 16rpx;
  align-items: center;
}

.picker-view {
  font-size: 28rpx;
  color: #666;
  padding: 0 16rpx;
}

.search-btn {
  height: 80rpx;
  padding: 0 32rpx;
  background-color: #007aff;
  color: #fff;
  border-radius: 40rpx;
  font-size: 28rpx;
}

.content-list {
  background-color: #fff;
  border-radius: 12rpx;
  overflow: hidden;
  margin-bottom: 20rpx;
}

.list-header {
  display: flex;
  background-color: #f9f9f9;
  border-bottom: 1rpx solid #e5e5e5;
}

.list-row {
  display: flex;
  border-bottom: 1rpx solid #f0f0f0;
}

.list-col {
  flex: 1;
  padding: 24rpx 16rpx;
  text-align: center;
  font-size: 28rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  word-break: break-all;
}

.status-pending {
  color: #ff9500;
}

.status-approved {
  color: #4cd964;
}

.status-rejected {
  color: #ff3b30;
}

.btn-detail {
  background-color: #007aff;
  color: #fff;
  margin: 0 8rpx;
}

.btn-audit {
  background-color: #5ac8fa;
  color: #fff;
  margin: 0 8rpx;
}

.btn-delete {
  background-color: #ff3b30;
  color: #fff;
  margin: 0 8rpx;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 24rpx;
  padding: 20rpx;
  background-color: #fff;
  border-radius: 12rpx;
  font-size: 28rpx;
}

.pagination button {
  padding: 16rpx 32rpx;
  border-radius: 8rpx;
  background-color: #007aff;
  color: #fff;
}

.pagination button:disabled {
  background-color: #e5e5e5;
  color: #999;
}

.audit-form {
  padding: 20rpx 0;
}

.audit-status-picker {
  padding: 16rpx;
  border: 1rpx solid #e5e5e5;
  border-radius: 8rpx;
  font-size: 28rpx;
  margin-bottom: 20rpx;
}

.reason-input {
  width: 100%;
  height: 160rpx;
  padding: 16rpx;
  border: 1rpx solid #e5e5e5;
  border-radius: 8rpx;
  font-size: 28rpx;
  box-sizing: border-box;
}
</style>
